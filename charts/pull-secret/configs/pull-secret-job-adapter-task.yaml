apiVersion: batch/v1
kind: Job
metadata:
  name: "pull-secret-{{ .clusterId | lower }}-{{ .generationId }}"
  namespace: "{{ .clusterId | lower }}"
  labels:
    hyperfleet.io/cluster-id: "{{ .clusterId }}"
    hyperfleet.io/managed-by: "{{ .managedByResourceName }}"
    hyperfleet.io/resource-type: "pull-secret-job"
    app: pull-secret
  annotations:
    hyperfleet.io/generation: "{{ .generationId }}"
spec:
  backoffLimit: 0
  # Maximum time to wait for k8s job completion (maxWaitTimeSeconds + 10 second buffer)
  activeDeadlineSeconds: 310
  template:
    metadata:
      labels:
        app: pull-secret
        hyperfleet.io/cluster-id: "{{ .clusterId }}"
    spec:
      # Created before the job is created, as specified in the adapter configuration.
      serviceAccountName: "{{ .adapterTaskServiceAccount }}"
      restartPolicy: Never
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      volumes:
        - name: results
          emptyDir: {}
        # Required for readOnlyRootFilesystem: true - provides writable /tmp
        - name: tmp
          emptyDir: {}
      containers:
        # Pull Secret Adapter Container
        - name: pull-secret
          image: "{{ .pullSecretImage }}"
          imagePullPolicy: Always
          command:
            - /usr/local/bin/pull-secret
          args:
            - run-job
            - pull-secret
          env:
            # Required
            - name: GCP_PROJECT_ID
              value: "{{ .projectId }}"
            - name: CLUSTER_ID
              value: "{{ .clusterId }}"
            - name: SECRET_NAME
              value: "{{ if .secretName }}{{ .secretName }}{{ else }}hyperfleet-{{ .clusterId }}-pull-secret{{ end }}"
            - name: PULL_SECRET_DATA
              value: "{{ .pullSecretData }}"
            - name: RESULTS_PATH
              value: "{{ .resultPath }}"
            # Logging
            - name: LOG_LEVEL
              value: "{{ .logLevel }}"
          volumeMounts:
            - name: results
              mountPath: /results
            - name: tmp
              mountPath: /tmp
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "500m"
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL

        # Status reporter sidecar
        - name: status-reporter
          image: "{{ .statusReporterImage }}"
          imagePullPolicy: Always
          env:
            # Required environment variables
            - name: JOB_NAME
              value: "pull-secret-{{ .clusterId | lower }}-{{ .generationId }}"
            - name: JOB_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            # Optional configuration
            - name: RESULTS_PATH
              value: "{{ .resultPath }}"
            - name: POLL_INTERVAL_SECONDS
              value: "2"
            - name: MAX_WAIT_TIME_SECONDS
              value: "{{ .maxWaitTimeSeconds }}"
            - name: CONDITION_TYPE
              value: "Available"
            - name: LOG_LEVEL
              value: "{{ .logLevel }}"
            - name: ADAPTER_CONTAINER_NAME
              value: "pull-secret"
          volumeMounts:
            - name: results
              mountPath: /results
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "128Mi"
              cpu: "200m"
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL
